{"version":3,"sources":["../src/SparceCoverageCollector.js"],"names":["SparceCoverageCollector","srcCoverage","metaInfo","filename","data","path","statementMap","fnMap","branchMap","s","b","f","indexes","lastIndex","meta","filePath","fileCoverage","source","getSourceCoverage","code","srcItem","hits","key","locations","map","push","loc","start","line","column","end","join","index","v","i","length"],"mappings":"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","file":"SparceCoverageCollector.js","sourcesContent":["export default class SparceCoverageCollector {\n\tconstructor() {\n\t\tthis.srcCoverage = {};\n\t\tthis.metaInfo = {};\n\t}\n\n\tgetSourceCoverage(filename) {\n\t\tlet data = this.srcCoverage[filename];\n\t\tif (!data) {\n\t\t\tdata = this.srcCoverage[filename] = {\n\t\t\t\tpath: filename,\n\t\t\t\tstatementMap: {},\n\t\t\t\tfnMap: {},\n\t\t\t\tbranchMap: {},\n\t\t\t\ts: {},\n\t\t\t\tb: {},\n\t\t\t\tf: {},\n\t\t\t};\n\t\t\tthis.metaInfo[filename] = {\n\t\t\t\tindexes: {},\n\t\t\t\tlastIndex: {\n\t\t\t\t\ts: 0,\n\t\t\t\t\tb: 0,\n\t\t\t\t\tf: 0,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tdata,\n\t\t\tmeta: this.metaInfo[filename],\n\t\t};\n\t}\n\n\tsetCoverage(filePath, fileCoverage) {\n\t\tthis.srcCoverage[filePath] = fileCoverage;\n\t}\n\n\tsetSourceCode(filePath, source) {\n\t\tthis.getSourceCoverage(filePath).data.code = source;\n\t}\n\n\n\tgetFinalCoverage() {\n\t\treturn this.srcCoverage;\n\t}\n\n\tupdateBranch(source, srcItem, hits) {\n\t\tconst { data, meta } = this.getSourceCoverage(source);\n\n\t\tlet key = ['b'];\n\t\tsrcItem.locations.map(loc => key.push(\n\t\t\tloc.start.line, loc.start.column,\n\t\t\tloc.end.line, loc.end.line\n\t\t));\n\n\t\tkey = key.join(':');\n\n\t\tlet index = meta.indexes[key];\n\t\tif (!index) {\n\t\t\tmeta.lastIndex.b += 1;\n\t\t\tindex = meta.lastIndex.b;\n\t\t\tmeta.indexes[key] = index;\n\t\t\tdata.branchMap[index] = srcItem;\n\t\t}\n\n\t\tif (!data.b[index]) {\n\t\t\tdata.b[index] = hits.map(v => v);\n\t\t} else {\n\t\t\tfor (let i = 0; i < hits.length; i += 1) {\n\t\t\t\tdata.b[index][i] += hits[i];\n\t\t\t}\n\t\t}\n\t}\n\n\tupdateFunction(source, srcItem, hits) {\n\t\tconst { data, meta } = this.getSourceCoverage(source);\n\n\t\tconst key = [\n\t\t\t'f',\n\t\t\tsrcItem.loc.start.line, srcItem.loc.start.column,\n\t\t\tsrcItem.loc.end.line, srcItem.loc.end.column,\n\t\t].join(':');\n\n\t\tlet index = meta.indexes[key];\n\t\tif (!index) {\n\t\t\tmeta.lastIndex.f += 1;\n\t\t\tindex = meta.lastIndex.f;\n\t\t\tmeta.indexes[key] = index;\n\t\t\tdata.fnMap[index] = srcItem;\n\t\t}\n\n\t\tdata.f[index] = data.f[index] || 0;\n\t\tdata.f[index] += hits;\n\t}\n\n\tupdateStatement(source, srcItem, hits) {\n\t\tconst { data, meta } = this.getSourceCoverage(source);\n\n\t\tconst key = [\n\t\t\t's',\n\t\t\tsrcItem.start.line, srcItem.start.column,\n\t\t\tsrcItem.end.line, srcItem.end.column,\n\t\t].join(':');\n\n\t\tlet index = meta.indexes[key];\n\t\tif (!index) {\n\t\t\tmeta.lastIndex.s += 1;\n\t\t\tindex = meta.lastIndex.s;\n\t\t\tmeta.indexes[key] = index;\n\t\t\tdata.statementMap[index] = srcItem;\n\t\t}\n\n\t\tdata.s[index] = data.s[index] || 0;\n\t\tdata.s[index] += hits;\n\t}\n}\n"]}