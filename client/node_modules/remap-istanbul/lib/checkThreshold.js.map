{"version":3,"sources":["../src/checkThreshold.js"],"names":["checkThreshold","mixin","destination","i","arguments","length","source","key","overrideThresholds","overrides","thresholds","Object","keys","some","pattern","normalize","dot","removeFiles","covObj","patterns","obj","forEach","found","checkOpt","collector","defaultThresholds","global","statements","branches","lines","functions","excludes","each","rawCoverage","getFinalCoverage","globalResults","utils","summarizeCoverage","eachResults","summarizeFileCoverage","coverageFailed","check","name","actuals","actual","pct","actualUncovered","total","covered","threshold","console","error","keyThreshold"],"mappings":"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","file":"checkThreshold.js","sourcesContent":["import istanbul from '../utils/node!istanbul';\nimport minimatch from '../utils/node!minimatch';\n\nfunction mixin(destination/*, ...mixins*/) {\n    for (var i = 1; i < arguments.length; i++) {\n        var source = arguments[i];\n        for (var key in source) {\n            destination[key] = source[key];\n        }\n    }\n    return destination;\n}\n\nfunction overrideThresholds (key, overrides) {\n    var thresholds = {};\n\n    // First match wins\n    Object.keys(overrides).some(function (pattern) {\n        if (minimatch(normalize(key), pattern, {dot: true})) {\n            thresholds = overrides[pattern];\n            return true;\n        }\n    });\n\n    return thresholds;\n}\n\nfunction removeFiles (covObj, patterns) {\n    var obj = {};\n\n    Object.keys(covObj).forEach(function (key) {\n        // Do any patterns match the resolved key\n        var found = patterns.some(function (pattern) {\n            return minimatch(normalize(key), pattern, {dot: true});\n        });\n\n        // if no patterns match, keep the key\n        if (!found) {\n            obj[key] = covObj[key];\n        }\n    })\n\n    return obj;\n}\n\nexport default function checkThreshold(checkOpt, collector) {\n    var defaultThresholds = {\n\t\t\tglobal: {\n\t\t\t\tstatements: 0,\n\t\t\t\tbranches: 0,\n\t\t\t\tlines: 0,\n\t\t\t\tfunctions: 0,\n\t\t\t\texcludes: []\n\t\t\t},\n\t\t\teach: {\n\t\t\t\tstatements: 0,\n\t\t\t\tbranches: 0,\n\t\t\t\tlines: 0,\n\t\t\t\tfunctions: 0,\n\t\t\t\texcludes: [],\n\t\t\t\toverrides: {}\n\t\t\t}\n\t\t};\n\n    var thresholds = {\n        global: mixin(defaultThresholds.global, checkOpt.global),\n        each: mixin(defaultThresholds.each, checkOpt.each)\n    };\t\t\t\n\n    var rawCoverage = collector.getFinalCoverage();\n    var globalResults = istanbul.utils.summarizeCoverage(removeFiles(rawCoverage, thresholds.global.excludes));\n    var eachResults = removeFiles(rawCoverage, thresholds.each.excludes);\n\n    // Summarize per-file results and mutate original results.\n    Object.keys(eachResults).forEach(function (key) {\n        eachResults[key] = istanbul.utils.summarizeFileCoverage(eachResults[key]);\n    });\n\n    var coverageFailed = false;\n\n    function check (name, thresholds, actuals) {\n        var keys = [\n            'statements',\n            'branches',\n            'lines',\n            'functions'\n        ];\n\n        keys.forEach(function (key) {\n            var actual = actuals[key].pct;\n            var actualUncovered = actuals[key].total - actuals[key].covered;\n            var threshold = thresholds[key];\n\n            if (threshold < 0) {\n                if (threshold * -1 < actualUncovered) {\n                    coverageFailed = true;\n                    console.error('Uncovered count for ' + key + ' (' + actualUncovered + \t') exceeds ' + name + ' threshold (' + -1 * threshold + ')');\n                }\n            } else {\n                if (actual < threshold) {\n                    coverageFailed = true;\n                    console.error('Coverage for ' + key + ' (' + actual + '%) does not meet ' + name + ' threshold (' + threshold + '%)');\n                }\n            }\n        });\n    }\n\n    check('global', thresholds.global, globalResults);\n\n    Object.keys(eachResults).forEach(function (key) {\n        var keyThreshold = mixin(thresholds.each, overrideThresholds(key, thresholds.each.overrides));\n        check('per-file' + ' (' + key + ') ', keyThreshold, eachResults[key]);\n    })\n\n    return coverageFailed;\n}"]}